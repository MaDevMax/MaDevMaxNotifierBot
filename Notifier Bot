"""
MaDevMax Notifier Bot
Author: MaDevMax (Matveichuk Maxim)
GitHub: https://github.com/MaDevMax
Year: 2025
"""

import telebot
import os

TOKEN = "YOUR_TOKEN_HERE"
ADMIN_ID = 123456789  # —Å–≤–æ–π Telegram ID

bot = telebot.TeleBot(TOKEN)

USERS_FILE = "users.txt"
users = set()

if os.path.exists(USERS_FILE):
    with open(USERS_FILE, "r") as f:
        for line in f:
            line = line.strip()
            if line:
                users.add(int(line))
    print(f"[LOG] –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
else:
    print("[LOG] users.txt –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—Å—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.")


def save_user(user_id: int):
    if user_id not in users:
        users.add(user_id)
        with open(USERS_FILE, "a") as f:
            f.write(f"{user_id}\n")
        print(f"[LOG] –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}")


@bot.message_handler(commands=['start'])
def start_command(message):
    save_user(message.chat.id)
    bot.send_message(
        message.chat.id,
        "üîî –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî MaDevMax Notifier Bot.\n"
        "–¢—ã –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö.\n\n"
        "üëâ /help ‚Äî —Å–ø—Ä–∞–≤–∫–∞\n"
        "üëâ /stop ‚Äî –æ—Ç–ø–∏—Å–∫–∞"
    )


@bot.message_handler(commands=['help'])
def help_command(message):
    bot.send_message(
        message.chat.id,
        "–Ø —Ä–∞—Å—Å—ã–ª–∞—é –≤–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º.\n"
        "–ï—Å–ª–∏ —Ç—ã –∞–¥–º–∏–Ω, –∏—Å–ø–æ–ª—å–∑—É–π:\n"
        "`/send –¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏` üì®"
    )


@bot.message_handler(commands=['stop'])
def stop_command(message):
    uid = message.chat.id
    if uid in users:
        users.remove(uid)
        with open(USERS_FILE, "w") as f:
            for user in users:
                f.write(f"{user}\n")
        bot.send_message(uid, "üö´ –¢—ã –æ—Ç–ø–∏—Å–∞–ª—Å—è –æ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.")
        print(f"[LOG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —É–¥–∞–ª—ë–Ω –∏–∑ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.")
    else:
        bot.send_message(uid, "–¢—ã –∏ —Ç–∞–∫ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.")


@bot.message_handler(commands=['send'])
def admin_send(message):
    if message.from_user.id != ADMIN_ID:
        bot.send_message(message.chat.id, "‚ùå –ù–µ—Ç –ø—Ä–∞–≤.")
        return

    text = message.text.replace("/send", "").strip()
    if not text:
        bot.send_message(message.chat.id, "–ü–æ—Å–ª–µ /send –¥–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.")
        return

    sent, failed = 0, 0
    for uid in users:
        try:
            bot.send_message(uid, text)
            sent += 1
        except Exception as e:
            failed += 1
            print(f"[LOG] –û—à–∏–±–∫–∞ {uid}: {e}")

    reply = f"‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ {sent}"
    if failed:
        reply += f"\n‚ö†Ô∏è –û—à–∏–±–æ–∫: {failed}"
    bot.send_message(message.chat.id, reply)
    print(f"[LOG] –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {sent} / {failed}.")


print("üîπ MaDevMax Notifier Bot –∑–∞–ø—É—â–µ–Ω...")
bot.polling(none_stop=True)
